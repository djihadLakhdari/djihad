
<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title><?= htmlspecialchars($product['name']) ?></title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <link rel="stylesheet" href="product.css">

</head>
<body>

<div class="container">
  <div class="product-section">
   <div class="image-side">
  <form method="post" action="toggle_favorite.php" class="favorite-form">
    <input type="hidden" name="product_id" value="<?= $product['id'] ?>">
    <button type="submit">
      <i class="fa<?= in_array($product['id'], $favorites) ? 's' : 'r' ?> fa-heart" style="color: <?= in_array($product['id'], $favorites) ? 'red' : '#bbb' ?>;"></i>
    </button>
  </form>
  <img src="<?= htmlspecialchars($product['image']) ?>" alt="<?= htmlspecialchars($product['name']) ?>">
</div><div class="info-side">
        
      <h1><?= htmlspecialchars($product['name']) ?></h1>
      <p>Ø§Ù„ØªØµÙ†ÙŠÙ: <?= htmlspecialchars($product['category_name']) ?></p>
<p>Ø§Ù„ÙˆØµÙ: <?= htmlspecialchars(substr($product['description'], 0, 1800)) ?></p>
      <div class="price">ğŸ’° <?= $product['price'] ?> Ø¯Ø¬</div>

      <form method="post" action="cart.php">
        <input type="hidden" name="product_id" value="<?= $product['id'] ?>">
        <button class="add-to-cart-btn" data-id="<?= $product['id'] ?>"> Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
      </form>
    </div>
  </div>

  <div class="review-section">
    <h2>â­ï¸ Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚Ùƒ</h2>

    <?php if ($error): ?>
      <div class="error"><?= $error ?></div>
    <?php endif; ?>

    <form method="post">
      <div class="stars">
        <input type="radio" id="star5" name="rating" value="5" /><label for="star5">â˜…</label>
        <input type="radio" id="star4" name="rating" value="4" /><label for="star4">â˜…</label>
        <input type="radio" id="star3" name="rating" value="3" /><label for="star3">â˜…</label>
        <input type="radio" id="star2" name="rating" value="2" /><label for="star2">â˜…</label>
        <input type="radio" id="star1" name="rating" value="1" /><label for="star1">â˜…</label>
      </div>

      <textarea name="comment" placeholder="ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

      <button type="submit" name="submit_review">Ø¥Ø±Ø³Ø§Ù„</button>
    </form>

    <h2>ğŸ“ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>

    <?php if (count($reviews) === 0): ?>
      <p style="text-align:center; color:#777;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</p>
    <?php else:
      foreach ($reviews as $review):
        $is_owner = ($review['user_id'] == $user_id);
    ?>
      <div class="review-box" id="review-<?= $review['id'] ?>">
        <strong><?= htmlspecialchars($review['name']) ?></strong> - 
        <span class="review-stars"><?= str_repeat('â˜…', $review['rating']) ?></span>
        <?php if (!empty($review['comment'])): ?>
          <p><?= nl2br(htmlspecialchars($review['comment'])) ?></p>
        <?php endif; ?>

        <?php if ($is_owner): ?>
          <div class="review-actions">
          
            <form method="post" style="display:inline-block;">
              <input type="hidden" name="review_id" value="<?= $review['id'] ?>">
              <button type="submit" name="delete_review">Ø­Ø°Ù</button>
            </form>
            <button onclick="showEditForm(<?= $review['id'] ?>)">ØªØ¹Ø¯ÙŠÙ„</button>
          </div>
          <div id="edit-form-<?= $review['id'] ?>" style="display:none; margin-top:10px;">
            <form method="post">
              <input type="hidden" name="review_id" value="<?= $review['id'] ?>">
              <div class="stars" style="justify-content: flex-start;">
                <?php for($i=5; $i>=1; $i--): ?>
                  <input type="radio" id="edit-star-<?= $review['id'] ?>-<?= $i ?>" name="rating" value="<?= $i ?>" <?= ($review['rating'] == $i) ? 'checked' : '' ?> />
                  <label for="edit-star-<?= $review['id'] ?>-<?= $i ?>">â˜…</label>
                <?php endfor; ?>
              </div>
              <textarea name="comment" required><?= htmlspecialchars($review['comment']) ?></textarea>
              <button type="submit" name="edit_review">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
              <button type="button" onclick="hideEditForm(<?= $review['id'] ?>)">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
          </div>
        <?php endif; ?>
      </div>
    <?php endforeach; endif; ?>
  </div>
</div>
<script>
$(document).ready(function(){
  $(".add-to-cart-btn").click(function(e){
    e.preventDefault();
    var product_id = $(this).data("id");$.ajax({
      url: "add_to_cart_ajax.php",
      method: "POST",
      data: { product_id: product_id },
      dataType: "json",
      success: function(response){
        if(response.status == "success"){
          alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
          $(".cart-count").text(response.cart_count);
        } else if(response.message == "not_logged_in") {
          alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.");
          window.location.href = "login.php";
        } else {
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + response.message);
        }
      },
      error: function(){
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.");
      }
    });
  });
});
function showEditForm(id) {
  $("#edit-form-" + id).show();
}
function hideEditForm(id) {
  $("#edit-form-" + id).hide();
}
</script>

<script>
document.querySelectorAll('.favorite-form').forEach(form => {
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    const heartIcon = form.querySelector('i');

    fetch('toggle_favorite.php', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'added') {
        heartIcon.classList.remove('far');
        heartIcon.classList.add('fas');
        heartIcon.style.color = 'red';
      } else if (data.status === 'removed') {
        heartIcon.classList.remove('fas');
        heartIcon.classList.add('far');
        heartIcon.style.color = '#bbb';
      }
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ AJAX:', err);
    });
  });
});
</script>
</body>
</html>